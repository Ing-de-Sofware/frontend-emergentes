<div class="edit-form-container">
  <h2>Editar informaci贸n de lote</h2>
  <p class="description">Modifica los detalles b谩sicos de tu lote activo.</p>

  <!-- Manejo del estado de carga inicial y errores -->
  <div *ngIf="isLoading && !errorMessage" class="loading-message">
    <i class="fas fa-spinner fa-spin"></i> Cargando informaci贸n del lote...
  </div>

  <div *ngIf="errorMessage" class="error-alert">
    <p>隆Error al cargar el lote!</p>
    <p>{{ errorMessage }}</p>
    <button (click)="router.navigate(['/sidenav/view-batch'])">Volver a Lotes</button>
  </div>

  <!-- Mostrar formulario solo si no est谩 cargando y no hay error -->
  <form [formGroup]="editForm" (ngSubmit)="onSubmit()" *ngIf="!isLoading && !errorMessage">

    <!-- Nombre del Lote -->
    <div class="form-group">
      <label for="nombreLote">Nombre del lote <span class="required">*</span></label>
      <input
        id="nombreLote"
        type="text"
        formControlName="nombreLote"
        [class.is-invalid]="f['nombreLote'].invalid"
      >
      <div *ngIf="f['nombreLote'].invalid" class="error-message">
        El nombre del lote es obligatorio.
      </div>
    </div>

    <!-- Nombre de la Finca -->
    <div class="form-group">
      <label for="nombreFinca">Nombre de la finca <span class="required">*</span></label>
      <input
        id="nombreFinca"
        type="text"
        formControlName="nombreFinca"
        [class.is-invalid]="f['nombreFinca'].invalid"
      >
      <div *ngIf="f['nombreFinca'].invalid" class="error-message">
        El nombre de la finca es obligatorio.
      </div>
    </div>

    <!-- Variedad -->
    <div class="form-group">
      <label for="variedad">Variedad <span class="required">*</span></label>
      <input
        id="variedad"
        type="text"
        formControlName="variedad"
        [class.is-invalid]="f['variedad'].invalid"
      >
      <div *ngIf="f['variedad'].invalid" class="error-message">
        La variedad es obligatoria.
      </div>
    </div>

    <!-- Fecha de Cosecha -->
    <div class="form-group">
      <label for="fechaCosecha">Fecha de cosecha <span class="required">*</span></label>
      <div class="input-with-icon">
        <input
          id="fechaCosecha"
          type="date"
          formControlName="fechaCosecha"
          placeholder="AAAA-MM-DD"
          [class.is-invalid]="f['fechaCosecha'].invalid"
        >
        <i class="fas fa-calendar-alt calendar-icon"></i>
      </div>
      <div *ngIf="f['fechaCosecha'].invalid" class="error-message">
        La fecha de cosecha es obligatoria.
      </div>
    </div>

    <!-- Descripci贸n (Opcional) - Nota: No est谩 en el TS, pero se mantiene si lo quieres agregar despu茅s -->
    <!--
    <div class="form-group">
      <label for="descripcion">Descripci贸n o notas</label>
      <textarea id="descripcion" formControlName="descripcion" rows="5"></textarea>
    </div>
    -->

    <!-- rea de subida de Imagen (Ajustada para input type="file") -->
    <div class="image-upload-area">
      <p class="upload-text">
        Imagen representativa (opcional)
      </p>

      <!--  INPUT REAL DE ARCHIVO -->
      <input
        type="file"
        id="imageFile"
        accept="image/*"
        (change)="onFileSelected($event)"
        style="display: none;"
        #fileInput
      >

      <p class="upload-subtext">
        <span *ngIf="selectedFile">Archivo seleccionado: <strong>{{ selectedFile?.name }}</strong></span>

        <span *ngIf="!selectedFile && currentBatchData?.imageUrl">
    URL actual: {{ currentBatchData?.imageUrl | slice:0:30 }}...
  </span>

        <span *ngIf="!selectedFile && currentBatchData && !currentBatchData.imageUrl">
    No hay imagen actualmente.
  </span>
      </p>

      <!-- Bot贸n que simula el clic en el input de tipo file -->
      <button type="button" class="search-file-button" (click)="fileInput.click()">
        {{ selectedFile ? 'Cambiar archivo' : 'Buscar archivo' }}
      </button>

      <!-- Bot贸n para limpiar (opcional) -->
      <button
        *ngIf="selectedFile"
        type="button"
        class="cancel-button"
        (click)="selectedFile = null; fileInput.value = ''"
        [disabled]="isSaving"
      >
        Quitar
      </button>
    </div>

    <p class="trazability-message">
      Los cambios se firmar谩n digitalmente y se registrar谩n en blockchain para garantizar la integridad y trazabilidad de la informaci贸n.
    </p>

    <div class="action-buttons">
      <button
        type="submit"
        [disabled]="editForm.invalid || isSaving"
        class="save-button"
      >
        <i *ngIf="isSaving" class="fas fa-spinner fa-spin"></i>
        {{ isSaving ? ' Guardando...' : 'Guardar cambios' }}
      </button>
      <button
        type="button"
        (click)="cancelEdit()"
        class="cancel-button"
        [disabled]="isSaving"
      >
        Cancelar
      </button>
    </div>
  </form>
</div>
