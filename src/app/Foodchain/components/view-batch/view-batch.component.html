<div class="batch-list-container">
  <div class="header-section">
    <div class="title-and-description">
      <h2>Lotes de {{ currentUser?.companyName || 'la Compañía' }}</h2>
      <p *ngIf="errorMessage && !isLoading" class="error-message">{{ errorMessage }}</p>

      <p *ngIf="!errorMessage && !isLoading && currentUser?.companyOption === 'create'">
        Visualiza y gestiona tus lotes de productos.
      </p>
      <p *ngIf="!errorMessage && !isLoading && currentUser?.companyOption === 'join'">
        Visualiza los lotes activos de tu empresa.
      </p>
      <p *ngIf="isLoading">Cargando lotes...</p>
    </div>

    <button class="create-button" routerLink="/sidenav/create-batch" *ngIf="currentUser?.companyOption === 'create'">
      <i class="fas fa-plus"></i> Crear Nuevo Lote
    </button>
  </div>

  <div class="toolbar-section">
    <div class="toolbar-icons">
      <input type="text" [(ngModel)]="searchText" placeholder="Buscar por Lote o ID" class="search-input">

      <i class="fas fa-filter icon-button"></i>
      <i class="fas fa-calendar-alt icon-button"></i>
      <i class="fas fa-download icon-button"></i>
      <i class="fas fa-bars icon-button"></i>
    </div>
  </div>

  <div class="table-responsive">
    <table>
      <thead>
      <tr>
        <th>Lote</th>
        <th>Estado</th>
        <th>Fecha de creación</th>
        <th>Fecha de Cosecha</th>
        <th>Acciones</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let batch of filteredBatches">

        <td>{{ batch.lotName }} (ID: {{ batch.id }})</td>

        <td>
          <span class="status-tag"
                [class.active]="batch.state === 'Activo' || batch.state === 'Draft'"
                [class.closed]="batch.state === 'Cerrado'"
                [class.review]="batch.state === 'En Revisión'">
              {{ batch.state }}
          </span>
        </td>

        <td>{{ batch.createdDate | date: 'yyyy-MM-dd' }}</td>

        <td>{{ batch.harvestDate | date: 'yyyy-MM-dd' }}</td>

        <td class="action-links">
          <a (click)="viewDetail(batch.id)">Ver detalle</a>

          <ng-container *ngIf="currentUser?.companyOption === 'create'">
            | <a (click)="editBatch(batch.id)">Editar</a>
            | <a (click)="generateQR(batch.id)">Generar QR</a>

            <ng-container *ngIf="batch.state === 'Activo' || batch.state === 'Draft'">
              | <a (click)="closeBatch(batch.id)">Cerrar lote</a>
            </ng-container>
          </ng-container>

        </td>
      </tr>
      <tr *ngIf="!filteredBatches.length && !isLoading && !errorMessage">
        <td colspan="5" style="text-align: center; color: #6b7280; padding: 20px;">No se encontraron lotes para este usuario.</td>
      </tr>
      </tbody>
    </table>
  </div>

  <div class="pagination-section">
    <i class="fas fa-angle-left icon-button"></i>
    <span>
      <a [class.active-page]="currentPage === 1">1</a>
      <a [class.active-page]="currentPage === 2">2</a>
      <a [class.active-page]="currentPage === 3">3</a>
      ...
      <a [class.active-page]="currentPage === totalPages">{{ totalPages }}</a>
    </span>
    <i class="fas fa-angle-right icon-button"></i>
  </div>
</div>

<div *ngIf="showQrModal" class="qr-modal-overlay" (click)="closeQrModal()">
  <div class="qr-modal-content" (click)="$event.stopPropagation()">
    <button class="qr-close-button" (click)="closeQrModal()">&times;</button>
    <h3>Código QR para Lote: {{ qrCodeBatchId }}</h3>
    <p>Escanea este código para ver la trazabilidad del lote.</p>

    <div class="qr-code-display">

      <qrcode
        [qrdata]="qrData"
        [width]="256"
        [colorDark]="'#333333'"
        [colorLight]="'#ffffff'"
        [allowEmptyString]="true"
      ></qrcode>
    </div>

    <p class="qr-code-url">{{ qrData }}</p>
  </div>
</div>
