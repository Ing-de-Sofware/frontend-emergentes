<div class="register-step-container">
  <div class="header-section">
    <h2>Registro de Paso</h2>
    <p>Documenta una actividad de trazabilidad para uno de tus lotes.</p>
  </div>

  <form [formGroup]="stepForm" (ngSubmit)="onSubmit()">

    <div *ngIf="isLoading" class="text-muted alert alert-info">Cargando lotes disponibles y geolocalización...</div>
    <div *ngIf="errorMessage && !isLoading" class="text-danger alert alert-warning">
      {{ errorMessage }}
    </div>

    <div class="form-group-row">

      <div class="form-group">
        <label for="lotId">Lote <span class="required">*</span></label>
        <select
          id="lotId"
          formControlName="lotId"
          class="form-control"
          [class.is-invalid]="f['lotId'].invalid"
        >
          <option value="" disabled>Seleccionar Lote</option>
          <option *ngFor="let lot of availableLots" [value]="lot.id">
            {{ lot.lotName }} (ID: {{ lot.id }})
          </option>
        </select>

        <div *ngIf="f['lotId'].invalid" class="text-danger validation-error">
          El Lote es requerido.
        </div>
      </div>

      <div class="form-group">
        <label for="stepType">Tipo de paso <span class="required">*</span></label>
        <select
          id="stepType"
          formControlName="stepType"
          class="form-control"
          [class.is-invalid]="f['stepType'].invalid"
        >
          <option value="" disabled>Seleccionar Tipo</option>
          <option *ngFor="let type of stepTypes" [value]="type">{{ type }}</option>
        </select>
        <div *ngIf="f['stepType'].invalid" class="text-danger validation-error">
          El Tipo de paso es requerido.
        </div>
      </div>

    </div>

    <div class="form-group-row">

      <div class="form-group">
        <label for="stepDate">Fecha <span class="required">*</span></label>
        <input
          type="date"
          id="stepDate"
          formControlName="stepDate"
          class="form-control"
          [class.is-invalid]="f['stepDate'].invalid"
        >
        <div *ngIf="f['stepDate'].invalid" class="text-danger validation-error">
          La Fecha es requerida.
        </div>
      </div>

      <div class="form-group">
        <label for="stepTime">Hora <span class="required">*</span></label>
        <input
          type="time"
          id="stepTime"
          formControlName="stepTime"
          class="form-control"
          [class.is-invalid]="f['stepTime'].invalid"
        >
        <div *ngIf="f['stepTime'].invalid" class="text-danger validation-error">
          La Hora es requerida.
        </div>
      </div>
    </div>

    <div class="form-group-full">
      <label for="location">Ubicación <span class="required">*</span></label>
      <input
        type="text"
        id="location"
        formControlName="location"
        class="form-control"
        placeholder="Ubicación capturada automáticamente (lat, lon)"
        [class.is-invalid]="f['location'].invalid"
        readonly
      >
      <small class="text-muted">Ubicación capturada automáticamente. No editable.</small>
      <div *ngIf="f['location'].invalid" class="text-danger validation-error">
        La Ubicación es requerida.
      </div>
    </div>

    <div class="map-placeholder">
      <google-map
        *ngIf="center.lat !== 0"
        [options]="mapOptions"
        height="300px"
        width="100%"
      >
        <map-marker [options]="markerOptions"></map-marker>
      </google-map>
      <div *ngIf="center.lat === 0" style="height: 300px; display: flex; align-items: center; justify-content: center; background-color: #f8f9fa; border: 1px solid #dee2e6;">
        Cargando mapa de ubicación...
      </div>
    </div>
    <small class="text-muted map-reference">Vista de referencia de la ubicación capturada</small>

    <div class="form-group-full observations-group">
      <label for="observations">Observaciones (Opcional)</label>
      <textarea id="observations" formControlName="observations" class="form-control" rows="4"></textarea>
    </div>

    <div class="action-buttons">
      <button
        type="submit"
        class="register-button"
        [disabled]="stepForm.invalid || isLoading || availableLots.length === 0"
      >
        <i class="fas fa-save"></i> Registrar Paso
      </button>
      <button type="button" class="cancel-button" (click)="router.navigate(['/sidenav/view-batch'])">Cancelar</button>
    </div>
  </form>
</div>
