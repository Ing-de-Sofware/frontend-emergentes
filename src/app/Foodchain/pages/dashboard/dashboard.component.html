<div class="dashboard-container">

  <h1 class="dashboard-title">Resumen de Operaciones</h1>

  @if (errorMessage && !isLoading) {
    <div class="alert alert-error">{{ errorMessage }}</div>
  }

  @if (!isLoading) {
    <div class="dashboard-header-grid">

      <div class="user-info-card card">
        <div class="user-avatar">
          <i class="fas fa-user-circle"></i>
        </div>
        <div class="user-details">
          <h3 class="user-name">{{ userFullName }}</h3>
          <p class="user-role">{{ currentUser.requestedRole || 'Rol' }}</p>
          <p class="user-company">{{ currentUser.companyName || 'Compa√±√≠a' }}</p>
          <p class="user-email">{{ currentUser.email || 'correo@ejemplo.com' }}</p>
        </div>
      </div>

      <div class="metrics-card-container">

        <div class="metric-item card">
          <i class="fas fa-cubes metric-icon"></i>
          <div class="metric-value">{{ metrics.totalLotes || 0 }}</div>
          <div class="metric-label">Total de Lotes</div>
        </div>

        <div class="metric-item card">
          <i class="fas fa-users metric-icon"></i>
          <div class="metric-value">{{ metrics.totalPersonal || 0 }}</div>
          <div class="metric-label">Personal en {{ currentUser.companyName }}</div>
        </div>

        <div class="metric-item card">
          <i class="fas fa-seedling metric-icon"></i>
          <div class="metric-value">{{ metrics.tiposEstado || 0 }}</div>
          <div class="metric-label">Lotes en Estado Activo</div>
        </div>

      </div>
    </div>
  }

  <div class="users-list-section card">
    <h2 class="section-title">üë• Personal de la Compa√±√≠a: {{ currentUser.companyName || '...' }}</h2>

    @if (isLoadingUsers) {
      <div class="loading-state">Cargando personal...</div>
    } @else if (companyUsers.length === 0) {
      <div class="no-data-message">No hay otros usuarios registrados en esta compa√±√≠a.</div>
    } @else {
      <div class="table-responsive">
        <table class="users-table">
          <thead>
          <tr>
            <th>Nombre</th>
            <th>Email</th>
            <th>Tel√©fono</th>
            <th>Rol</th>
            <th>Pasos Registrados</th>
            <th>Estado</th>
          </tr>
          </thead>
          <tbody>
            @for (user of companyUsers; track user.id) {
              <tr>
                <td>{{ user.firstName }} {{ user.lastName }}</td>
                <td>{{ user.email }}</td>
                <td>{{ user.phoneNumber || 'N/A' }}</td>
                <td><span class="role-tag role-{{ user.requestedRole | lowercase }}">{{ user.requestedRole }}</span></td>
                <td>
                  <span class="step-count-value">{{ user.stepCount }}</span>
                </td>
                <td><span class="status-indicator status-active"></span> Activo</td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
  </div>

  <hr>

  <div class="sorted-batches-section card mt-4">
    <h2 class="section-title">‚è±Ô∏è Lotes con Actividad Reciente</h2>
    <p class="section-subtitle">Ordenado por el √∫ltimo paso de trazabilidad registrado.</p>

    @if (isLoading) {
      <div class="loading-state">Calculando el orden de los lotes...</div>
    } @else if (sortedBatches.length === 0) {
      <div class="no-data-message">No hay lotes registrados para mostrar actividad.</div>
    } @else {
      <div class="table-responsive">
        <table class="users-table">
          <thead>
          <tr>
            <th>ID Lote</th>
            <th>Nombre Lote</th>
            <th>Estado Actual</th>
            <th>√öltimo Paso Registrado</th>
            <th>Fecha/Hora del Paso</th>
          </tr>
          </thead>
          <tbody>
            @for (batch of sortedBatches; track batch.id) {
              <tr>
                <td>{{ batch.id }}</td>
                <td>{{ batch.lotName }}</td>
                <td><span class="status-tag status-{{ batch.state | lowercase }}">{{ batch.state }}</span></td>
                <td>{{ batch.lastStepType || 'N/A' }}</td>
                <td>
                  @if (batch.lastStepDate) {
                    {{ batch.lastStepDate | date:'medium' }}
                  } @else {
                    Sin pasos
                  }
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
  </div>

</div>
